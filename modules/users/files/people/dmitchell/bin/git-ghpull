#! /usr/bin/env python2.7

import os
import sys
import json
import urllib2
import subprocess

# get config
try:
    github_username = subprocess.check_output(['git', 'config', 'ghpull.username']).strip()
    github_reponame = subprocess.check_output(['git', 'config', 'ghpull.reponame']).strip()
except subprocess.CalledProcessError:
    print "Set git config ghpull.username and ghpull.reponame"
    sys.exit(1)

try:
    github_options = subprocess.check_output(['git', 'config', 'ghpull.options']).strip().split()
except subprocess.CalledProcessError:
    github_options = []

def main():
    pullreq = sys.argv[1]
    url = 'https://api.github.com/repos/%s/%s/pulls/%s' % (github_username, github_reponame, pullreq)
    res = urllib2.urlopen(url)
    data = json.load(res)

    source_repo = data['head']['repo']['git_url']
    source_ref = data['head']['ref']

    os.execvp('git', ['git', 'pull'] + github_options + [source_repo, source_ref])

main()
