#! /bin/bash
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

distinguished_master=<%= scope.lookupvar('puppetmaster::settings::distinguished_master') %>
data_root=<%= scope.lookupvar('puppetmaster::settings::data_root') %>
mailto=<%= scope.lookupvar('::config::puppet_notif_email') %>

LOCKFILE="/dev/shm/puppetmaster-sync-log"
if ! lockfile -r 0 "${LOCKFILE}"; then
    echo "${LOCKFILE} already exists; not running rsync" \
        | mail -s "[PuppetAgain Changes] Rsync already running" "$mailto"
    exit
fi
trap "rm -f ${LOCKFILE}; exit" SIGHUP SIGINT SIGTERM EXIT

# make logfile that puppetsync can write to
logfile=$(mktemp)

# -H preserves hardlinks, saving some space
su - puppetsync -c "rsync -H -rlpt --delete --exclude=lost+found/ --out-format='%o %f %L' $distinguished_master:$data_root/ $data_root/" > $logfile

# if anything was logged..
if [ -s $logfile ]; then
    # if we're interactive, show the results
    tty -s && cat $logfile

    # email it
    mail -s "[PuppetAgain Changes] Files synchronized to "$(uname -n) "$mailto" < $logfile
fi
rm $logfile
